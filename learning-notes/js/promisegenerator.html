<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>promise | BLOG</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="Curriculum Vitae">
    <link rel="preload" href="/assets/css/0.styles.5ce1744f.css" as="style"><link rel="preload" href="/assets/js/app.5229a9c5.js" as="script"><link rel="preload" href="/assets/js/2.d0c61049.js" as="script"><link rel="preload" href="/assets/js/9.54be5433.js" as="script"><link rel="prefetch" href="/assets/js/10.01fd0c45.js"><link rel="prefetch" href="/assets/js/11.e59609e1.js"><link rel="prefetch" href="/assets/js/12.b28e5429.js"><link rel="prefetch" href="/assets/js/13.2720234c.js"><link rel="prefetch" href="/assets/js/14.0b33dd18.js"><link rel="prefetch" href="/assets/js/15.e4cad622.js"><link rel="prefetch" href="/assets/js/16.407e4663.js"><link rel="prefetch" href="/assets/js/17.7fe2abee.js"><link rel="prefetch" href="/assets/js/18.64d40d69.js"><link rel="prefetch" href="/assets/js/19.ae3ca64a.js"><link rel="prefetch" href="/assets/js/20.09a4c0e4.js"><link rel="prefetch" href="/assets/js/21.5646fdcd.js"><link rel="prefetch" href="/assets/js/22.aff186f1.js"><link rel="prefetch" href="/assets/js/23.c419c197.js"><link rel="prefetch" href="/assets/js/24.0bf626b6.js"><link rel="prefetch" href="/assets/js/25.b988f897.js"><link rel="prefetch" href="/assets/js/26.f1f04fec.js"><link rel="prefetch" href="/assets/js/27.c73a140c.js"><link rel="prefetch" href="/assets/js/28.f429846b.js"><link rel="prefetch" href="/assets/js/29.4cf38d3d.js"><link rel="prefetch" href="/assets/js/3.1b1aead2.js"><link rel="prefetch" href="/assets/js/30.f2c011aa.js"><link rel="prefetch" href="/assets/js/31.fc83628d.js"><link rel="prefetch" href="/assets/js/32.e8d14d93.js"><link rel="prefetch" href="/assets/js/4.dc1b9d45.js"><link rel="prefetch" href="/assets/js/5.d8b7d05d.js"><link rel="prefetch" href="/assets/js/6.58321c59.js"><link rel="prefetch" href="/assets/js/7.32db407e.js"><link rel="prefetch" href="/assets/js/8.0b662fca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ce1744f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learning-notes/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/keFei1996" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/learning-notes/" class="nav-link router-link-active">
  技术
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  面试题
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/keFei1996" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JS</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learning-notes/js/DOM事件机制.html" class="sidebar-link">DOM事件机制</a></li><li><a href="/learning-notes/js/ES6学习笔记.html" class="sidebar-link">ES6学习笔记</a></li><li><a href="/learning-notes/js/http协议类.html" class="sidebar-link">http协议类</a></li><li><a href="/learning-notes/js/promisegenerator.html" aria-current="page" class="active sidebar-link">promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning-notes/js/promisegenerator.html#promise-2" class="sidebar-link">promise</a></li><li class="sidebar-sub-header"><a href="/learning-notes/js/promisegenerator.html#generator" class="sidebar-link">Generator</a></li></ul></li><li><a href="/learning-notes/js/webpack配置及使用webpack优化项目实战.html" class="sidebar-link">webpack配置及使用webpack优化项目实战</a></li><li><a href="/learning-notes/js/深入理解CSS盒模型.html" class="sidebar-link">深入理解CSS盒模型</a></li><li><a href="/learning-notes/js/深入理解js原型链.html" class="sidebar-link">深入理解js原型链</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信小程序</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node.js</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>插件</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise"><a href="#promise" class="header-anchor">#</a> promise</h1> <div class="language- line-numbers-mode"><pre class="language-text"><code>  Promise
  Generator
  async/await
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="promise-2"><a href="#promise-2" class="header-anchor">#</a> promise</h2> <blockquote><p>promise是什么</p></blockquote> <p>官网解释 promise 表示一个异步操作的最终结果。</p> <p>翻译  <strong>可以将promise理解为一个状态机</strong>，它存在三种不同的状态，并在某一时刻只能有一种状态</p> <ul><li>pending 表示还在执行</li> <li>resolved 执行成功</li> <li>rejected 执行失败</li></ul> <p>一个promise是对一个异步操作的封装，异步操作有等待完成、成功和失败三种可能的结果，对应了promise的三种状态。</p> <p>promise的状态只能有pending转换位resolved或者pending转换为rejected，一旦状态转化完成就无法再改变。</p> <p>假设我们用promise封了一个异步操作，那么当它被创建的时候就处于pending状态，当异步操作成功完成时，
我们将状态转换为resolved，如果执行中出现错误，将状态转换为rejected。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> promise<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// code</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">/*异步操作成功 */</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h5 id="使用then方法获取结果"><a href="#使用then方法获取结果" class="header-anchor">#</a> 使用then方法获取结果</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> result<span class="token operator">=</span><span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./1.txt'</span><span class="token punctuation">)</span>
result<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//success</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//failure</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failure'</span><span class="token punctuation">,</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 将一个异步函数封装成promise，只要在回调函数中针对不同的返回结果调用resolve或者reject方法。</span>

<span class="token comment">// resolve函数会在异步操作成功完成时被调用，并将异步操作的返回值作为参数传递到外部。</span>
<span class="token comment">// reject是在异步操作出现异常时被调用，会将错误信息作为参数传递出去。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h5 id="then方法的返回值"><a href="#then方法的返回值" class="header-anchor">#</a> then方法的返回值</h5> <p>then方法总是返回一个新的promise对象，多次调用then方法，默认返回一个一个空的promise对象
使用return来来返回。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> promise<span class="token operator">=</span><span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./foo.txt'</span><span class="token punctuation">)</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//success</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'success'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// foo</span>
  <span class="token keyword">return</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./bar.txt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">//failure</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failure'</span><span class="token punctuation">,</span>error<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token comment">// bar</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="promise的执行"><a href="#promise的执行" class="header-anchor">#</a> promise的执行</h5> <ul><li>虽然我们是通过then方法来获取promise的结果，但是promise是当then方法调用之后才执行吗？</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> promise<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'begin'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span>
<span class="token comment">// 开始begin 5s后end</span>
<span class="token comment">// 运行顺序是，当promise从被创建的那一刻起就开始执行了，then方法只是提供了访问promise状态的接口，与promise的执行无关。</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="settimeout和promise的执行顺序"><a href="#settimeout和promise的执行顺序" class="header-anchor">#</a> setTimeout和promise的执行顺序</h3> <p>可以看出Promise比setTimeout()先执行。</p> <p>因为Promise定义之后便会立即执行，其后的.then()是异步里面的微任务。
而setTimeout()是异步的宏任务。</p> <p>需要注意的是Promise的实例化也属于同步任务，Promise的异步体现在then()和catch()中，
因此接下来会打印b，Promise调用then()方法，其回调函数会放入任务队列中等候，</p> <p>待主线程的任务执行完毕，再执行then中的回调函数</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">var</span> p<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2'</span><span class="token punctuation">)</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 2 4 1 3</span>
  <span class="token comment">// 可以看出Promise比setTimeout()先执行。</span>

<span class="token comment">// 因为Promise定义之后便会立即执行，其后的.then()是异步里面的微任务。</span>
<span class="token comment">// 而setTimeout()是异步的宏任务。</span>

<span class="token comment">// 需要注意的是Promise的实例化也属于同步任务，Promise的异步体现在then()和catch()中，</span>
<span class="token comment">// 因此接下来会打印b，Promise调用then()方法，其回调函数会放入任务队列中等候，</span>
<span class="token comment">// 待主线程的任务执行完毕，再执行then中的回调函数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h5 id="promise-常用的api"><a href="#promise-常用的api" class="header-anchor">#</a> promise 常用的api</h5> <ul><li>resolved</li> <li>rejected</li> <li>all</li> <li>race 方法接收一个promise数组作为参数并返回一个新的promise，数组中的promise会同时开始执行，race返回的promise的状态有数组中率先执行完毕的promise的状态决定</li> <li>catch 执行出错可以使用throw关键字抛出错误，并使用catch方法进行捕获</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code> <span class="token comment">// 如果有多个promise需要执行，可以使用promise.all()</span>
<span class="token comment">// 方法统一声明，改方法可以将多个promise对象包装成一个promise</span>
<span class="token comment">// 该方法接收一个数组作为参数，数据的元素如果不是promise对象，则回先调用resolve方法转换。</span>
<span class="token comment">//  如果中间有一个promise状态是reject，那么转换后的promise也会变成reject，并且将错误信息传给catch方法</span>
<span class="token keyword">var</span> promises<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'foo.txt'</span><span class="token punctuation">,</span><span class="token string">'bar.txt'</span><span class="token punctuation">,</span><span class="token string">'baz.txt'</span><span class="token punctuation">]</span>
promises<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// console.log(path)</span>
  <span class="token keyword">return</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token comment">// [ 'foo.txt', 'bar.txt', 'baz.txt' ] 顺序排列的</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// </span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h5 id="使用promise组织异步代码"><a href="#使用promise组织异步代码" class="header-anchor">#</a> 使用promise组织异步代码</h5> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 例子； 有三个文本文件需要顺序读取</span>
<span class="token keyword">var</span> lists<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'foo.txt'</span><span class="token punctuation">,</span><span class="token string">'bar.txt'</span><span class="token punctuation">,</span><span class="token string">'baz.txt'</span><span class="token punctuation">]</span>
<span class="token keyword">var</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'foo.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>readCB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>readCB<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>readCB<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">readCB</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// foo bar baz</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">++</span>count<span class="token operator">&gt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span>lists<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="generator"><a href="#generator" class="header-anchor">#</a> Generator</h2> <p>Generator本质上是一个函数，它最大的特点就是可以被中断，然后恢复执行。</p> <p>我们无法控制promise的执行，新建一个promise后，其状态自动转换为pending，同时开始执行，直到状态改变后我们才能进行下一步操作。</p> <p>而generator函数不同，generator函数可以由用户执行中断或者恢复执行的操作，generator中断后可以转去做别的操作，然后再回过头来从中断的地方恢复执行。</p> <h3 id="generator的使用"><a href="#generator的使用" class="header-anchor">#</a> generator的使用</h3> <p>generator函数和普通函数再外表上最大的区别有两个</p> <ol><li>在function关键字和方法名中间有个*</li> <li>方法体中使用yield关键字</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">Generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token string">'hello world'</span>
  <span class="token keyword">return</span> <span class="token string">'end'</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> gen<span class="token operator">=</span><span class="token function">Generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// { value: 'hello world', done: false }</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// {value: 'end', done: true}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// {value: undefined, done: true}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="data:image/png;base64,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" alt=""></p> <h4 id="generator的执行"><a href="#generator的执行" class="header-anchor">#</a> generator的执行</h4> <p>在调用generator函数之后，该函数并没有立刻执行，函数的返回结果也不是字符串，而是一个对象，可以将该对象理解为一个指针，指向generator函数当前的状态。</p> <p>在generator被调用后，指针指向方法体的开始行，当next方法调用后，该指针向下移动，方法也跟移动到下一个yield关键字，知道运行到方法的最后一行，
每次都返回一个包含执行信息的对象，包含一个表达式的值和一个标记执行状态的flag</p> <h4 id="generator中的错误处理"><a href="#generator中的错误处理" class="header-anchor">#</a> generator中的错误处理</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>function *generator(){
  try{
    yield console.log('hello')
  }catch(e){
    console.log(e)
  }
  yield console.log('world')
  return 'end'
}
var gen = generator()

gen.next()
gen.throw('throw error')
// hello 
// throw error
// world
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="generator组织异步方式"><a href="#generator组织异步方式" class="header-anchor">#</a> generator组织异步方式</h4> <p>我们之所以可以使用generator函数来处理异步任务，</p> <ol><li>generator函数可以中断和恢复执行，这个特性有yield关键字来实现。</li> <li>generator函数内外可以交换数据，这个特性有next函数来实现。</li></ol> <p>==总结：==
generator函数处理异步操作的核心思想：</p> <p>先将函数暂停在某处，然后拿到异步操作的结果，然后再把这个结果传到方法体内。</p> <p>yield关键字后面除了通常的函数表达式外，比较常见的是后面跟的是一个promise，由于yield关键字会对其后面的表达式进行求值并返回，那么调用next方法时就会返回一个promise对象，我们可以调用其then方法，并在回调中使用next方法将结果传回generator。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> fs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token keyword">yield</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'foo.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> g<span class="token operator">=</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> result<span class="token operator">=</span>g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
result<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  g<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="async-await"><a href="#async-await" class="header-anchor">#</a> async/await</h3> <p>async函数可以看做是自带执行器的generator函数</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token keyword">yield</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'too.txt'</span><span class="token punctuation">)</span>
    ocnsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
   
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>用async函数改写的话，会变成如下的形式</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">asyncReadFile</span><span class="token operator">=</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> result1<span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./foo.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// foo</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>形式上没有多大的变化，yield关键字换成了await，方法名字前面的*号变成了async关键字。</p> <p>在使用上的一个区别是await关键字，await关键字后面往往是一个promise，
await的动作和它的名字含义相同，---等待后面的promise执行完成后再进行下一步操作。</p> <p>await关键字后面往往是一个promise，如果不是就隐式调用promise.resolve来转换成一个promise。
await 等待后面的promise执行完成再进行下一步操作。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">asyncReadFile</span><span class="token operator">=</span><span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> result1<span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./foo.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// foo</span>
<span class="token punctuation">}</span>
<span class="token function">asyncReadFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h5 id="async返回值"><a href="#async返回值" class="header-anchor">#</a> async返回值</h5> <p>async函数总是会返回一个promise对象，如果return关键字后面不是一个promise，那么默认
调用promise。resolve方法进行转换。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asyncFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token string">'hello Node'</span>
<span class="token punctuation">}</span>
<span class="token function">asyncFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// hello Node</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h5 id="async函数的执行过程"><a href="#async函数的执行过程" class="header-anchor">#</a> async函数的执行过程</h5> <ol><li>在async函数开始执行的时候回自动生成一个promise对象。</li> <li>当方法体开始执行后，如果遇到return关键字或者throw关键字，执行会立刻退出，
如果遇到await关键字则回暂停执行 await后面的异步操作结束后会恢复执行</li> <li>执行完毕，返回一个promise</li></ol> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">asyncFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'begin'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token string">'hello Node'</span>
<span class="token punctuation">}</span>
<span class="token function">asyncFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// hello Node</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// begin </span>
<span class="token comment">// hello </span>
<span class="token comment">// end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h5 id="await"><a href="#await" class="header-anchor">#</a> await</h5> <p>await 操作符的结果是由其后面promise对象的操作结果来决定的，如果后面promise对象变为resolved,
await操作符发返回的值就是resolve的值；如果promise对象的状态变成rejected，那么await也会抛出reject的值。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token keyword">await</span> <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./foo.txt'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// foo</span>
<span class="token punctuation">}</span>
<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 等价于</span>
<span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'foo.txt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// foo</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h5 id="await于并行"><a href="#await于并行" class="header-anchor">#</a> await于并行</h5> <p>await会等待后面的promise完成后再采取下一步动作，这意味着当多个await操作时，程序会便成完全的
串行操作。</p> <p>当异步操作之间不存在依赖关系时，可以使用promise.all来实现并行。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">]</span><span class="token operator">=</span><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./foo.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./bar.txt'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result1<span class="token punctuation">,</span> result2<span class="token punctuation">)</span> <span class="token comment">// foo bar</span>
<span class="token punctuation">}</span>
<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 等价于</span>
<span class="token keyword">function</span> <span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./foo.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">readFile_promise</span><span class="token punctuation">(</span><span class="token string">'./baz.txt'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token comment">// [ 'foo', 'baz' ]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="await-总结"><a href="#await-总结" class="header-anchor">#</a> await 总结</h3> <blockquote><p>await关键字使用的一些关键点</p></blockquote> <ul><li>await关键字必须位于async函数内部</li> <li>await关键字后面需要是一个promise对象（不是的话就调用了resolve转换的）</li> <li>await关键字的返回结果就是在其后面promise执行的结果，可能是resolved或者rejected的值</li> <li>不能在普通箭头函数中使用await关键字，需要在箭头函数前面加上async关键字。</li> <li>await用来串行地执行异步操作，想实现并行使用promise.all</li></ul> <h3 id="async函数-的缺点"><a href="#async函数-的缺点" class="header-anchor">#</a> async函数 的缺点</h3> <ul><li>假设我们有很多层的方法调用，最底层的异步操作被封装成了async方法，那么该函数的所有上层方法可能都要变成async方法。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learning-notes/js/http协议类.html" class="prev">
        http协议类
      </a></span> <span class="next"><a href="/learning-notes/js/webpack配置及使用webpack优化项目实战.html">
        webpack配置及使用webpack优化项目实战
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5229a9c5.js" defer></script><script src="/assets/js/2.d0c61049.js" defer></script><script src="/assets/js/9.54be5433.js" defer></script>
  </body>
</html>
